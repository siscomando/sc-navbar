<link rel="import" href="../font-roboto/roboto.html">
<link rel="import" href="../core-toolbar/core-toolbar.html">
<link rel="import" href="../paper-elements/paper-elements.html">
<link rel="import" href="../core-icon/core-icon.html">
<link rel="import" href="../core-menu/core-menu.html">
<link rel="import" href="../core-ajax/core-ajax.html">
<link rel="import" href="../core-localstorage/core-localstorage.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../sc-item/sc-item.html">

<!--
sc-navbar is an custom element that retrieves and shows the issues. That
is required core-ajax.

##### Example

    <sc-navbar
      url="issues.json"
      username="chuangina" 
      online="true" 
      avatar="http://api.randomuser.me/portraits/thumb/women/79.jpg">
    </sc-navbar>

@element sc-navbar
@blurb Element providing the navbar to the sisComando app.
@status alpha
@homepage http://github.com/siscomando/sc-navbar
-->
<polymer-element name="sc-navbar" attributes="notitle url author username avatar online method">

  <template>
    <link rel="stylesheet" href="sc-navbar.css">
    <!-- get issues and to persist 
    Please to implement an throttle to request issues from time in times. 
    After this you can to remove auto. 
    -->
    <core-ajax id="coreAjax"
      auto
      url="{{url}}"
      response={{response}}
      handleAs="json"
      method="{{method ? method : 'GET'}}"
      >
    </core-ajax>

    <!-- presentation issues -->
    <div class="mainContent">
      <!-- menu item: This object fire core-select event -->
      <core-menu>
            <template repeat="{{issue in issues}}">
              <sc-item icon="{{issue.icon}}" scid="{{issue.register}}">
              	{{issue.title}}</sc-item>
            </template>            
      </core-menu>
    </div>
    
    <div class="profileMenu" horizontal layout>
      <div id="avatar">
        <core-icon icon="account-box" style="{{ avatar ? 'display: none;' : '' }}"></core-icon>
        <img src="{{ avatar }}" style="{{ avatar ? 'display: inline;' : 'display: none;'}}">
      </div>
      <div class="username" flex>{{username}}
        <span class="status">
          <core-icon icon="radio-button-on" 
            style="{{ online ? 'color: #B8E986;' : 'color: #CCC;' }}">
          </core-icon>{{online ? 'online' : 'offline' }}</span>
      </div>
      
    </div>
  </template>

  <script> 
    Polymer({ 
       /**
       * Fired when a item is selected.
       *
       *
       * @event sc-select
       */     
      /**
       * The `method` attribute sets an HTTP method to get issues.
       *
       * @attribute method
       * @type string
       * @default 'GET'
       */       
      /**
       * The `author` attribute sets an initial author
       *
       * @attribute author
       * @type string
       * @default 'Horacio Ibrahim'
       */
      author: 'Horacio Ibrahim', 
      /**
       * The `icons` attribute sets an type for the issue as high, 
       * high-infra, high-x.
       *
       *      Usage:
       *
       *          icons[0|1|2]
       * 
       * @attribute icons
       * @type string
       * @default 'error'
       */      
      publish: {
          displaySearch: {value: false, reflect: true},       
      },
      /* the best place to the constructor for array or object */
      created: function() {
        // initialize but it not is turned public to use by users of the element
        // to turn public to use attributes or publish.
      },
      responseChanged: function() {
      	  this.issues = this.response;
      	  window.localStorage.setItem("dbIssues",JSON.stringify(this.issues));

      },
      ready: function() {
        // Ready is a lifecycle callback.
        // You can do setup work in here.
        // More info: http://www.polymer-project.org/docs/polymer/polymer.html#lifecyclemethods
        // simple test alert(this.issueInfo.register);
        var scHeader = document.querySelector('sc-header');
        this.addEventListener('core-select', function(event){
        	if (event.detail.isSelected) {
        		var scid = event.detail.item.scid;
        		// access storage
        		var issuesSaved = JSON.parse(window.localStorage.getItem("dbIssues"));
        		for (var i=0; i< issuesSaved.length; i++) { 
        			// field to store id (_id, primary key) is register
        			if (issuesSaved[i]['register'] === scid) { 
        				this.fire('sc-select', {issue: issuesSaved[i]});
        			} 
        		}
        	}
        });
      },
    });
  </script>

</polymer-element>
